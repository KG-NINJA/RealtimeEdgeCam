<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>A-1 Robot Vision ‚Äì Poodle Mood</title>

<style>
* { box-sizing: border-box; }
body {
  margin:0;
  background:#000;
  color:#0f0;
  font-family: "Courier New", monospace;
  overflow:hidden;
}

/* UI */
#ui {
  position:fixed;
  top:15px; left:15px;
  background:rgba(0,0,0,0.95);
  border:2px solid #0f0;
  padding:12px;
  z-index:100;
  min-width:260px;
  box-shadow:0 0 20px rgba(0,255,0,0.3);
}
.status-line {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  border-bottom:1px solid #033;
  padding-bottom:4px;
}
.value { font-weight:bold; }

#robot-sim {
  position:fixed;
  right:15px; bottom:15px;
  width:260px; height:260px;
  border:3px solid #0f0;
  background:rgba(0,15,0,0.95);
  box-shadow:0 0 20px rgba(0,255,0,0.3);
}

#video { position:fixed; left:-9999px; }
#cv {
  position:absolute;
  inset:0;
  width:100vw;
  height:100vh;
  image-rendering:pixelated;
}
</style>
</head>

<body>

<canvas id="cv"></canvas>

<div id="ui">
  <b>üê© A-1 ROBOT VISION</b>
  <div class="status-line"><span>Ë∑ùÈõ¢</span><span id="obs-score" class="value">100</span></div>
  <div class="status-line"><span>Gemma</span><span id="gemma-status" class="value">ÂæÖÊ©ü</span></div>
  <div class="status-line"><span>Âãï‰Ωú</span><span id="robot-mode" class="value" style="color:#f00">ÂÅúÊ≠¢</span></div>
  <div class="status-line"><span>Âà§Êñ≠</span><span id="last-decision" class="value">-</span></div>
  <div class="status-line"><span>ÊÑüÊÉÖ</span><span id="emotion-display" class="value">üê© „ÅÜ„Çå„Åó„ÅÑÔºÅ</span></div>
</div>

<canvas id="robot-sim"></canvas>
<video id="video" autoplay playsinline muted></video>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>

<script>
/* =====================
   STATE
===================== */
const state = {
  cvReady:false,
  mlReady:false,
  mlEnabled:false,
  mlInFlight:false,
  lastObstacleScore:100,

  robotEnabled:false,
  robotX:130,
  robotY:130,
  robotTheta:0,
  robotVLin:0,
  robotVAng:0,
  targetVLin:0,
  targetVAng:0,

  gemmaThinking:false,
  gemmaNextAt:0,

  /* üê© ÊÑüÊÉÖ„É¢„Éá„É´ */
  emotionCore:'happy',
  emotionBase:'happy',
  emotionOverlay:null,
  emotionOverlayUntil:0,
  emotionState:'happy',
  emotionIntensity:0.7,
  emotionNextUpdate:0
};

const video = document.getElementById("video");
const cvCanvas = document.getElementById("cv");
const cvCtx = cvCanvas.getContext("2d");

cvCanvas.width = innerWidth;
cvCanvas.height = innerHeight;

/* =====================
   CAMERA
===================== */
navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
  video.srcObject=s;
  video.play();
});

/* =====================
   ML
===================== */
let model=null;
async function loadML(){
  if(model) return;
  model = await cocoSsd.load();
  state.mlReady=true;
  document.getElementById("gemma-status").textContent="Ê∫ñÂÇôÂÆå‰∫Ü";
}
async function runML(){
  if(!state.mlEnabled || !state.mlReady || state.mlInFlight) return;
  state.mlInFlight=true;
  const preds = await model.detect(video);
  if(preds.length){
    state.lastObstacleScore=Math.round(preds[0].score*100);
  } else {
    state.lastObstacleScore=100;
  }
  document.getElementById("obs-score").textContent=state.lastObstacleScore;
  state.mlInFlight=false;
}

/* =====================
   üê© POODLE EMOTION MODEL
===================== */
function updateEmotionalState(){
  const now=performance.now();
  if(now<state.emotionNextUpdate) return;
  state.emotionNextUpdate=now+250;

  const safe = state.lastObstacleScore>60;
  const verySafe = state.lastObstacleScore>80;
  const moving = state.robotEnabled && state.robotVLin>0.2;
  const fast = state.robotVLin>0.6;
  const thinking = state.gemmaThinking || state.mlInFlight;

  /* BASE */
  if(fast && verySafe){
    state.emotionBase='excited';
  } else if(moving && safe){
    state.emotionBase='happy';
  } else if(safe){
    state.emotionBase='confident';
  } else {
    state.emotionBase='curious';
  }

  /* OVERLAY */
  if(thinking){
    state.emotionOverlay='curious';
    state.emotionOverlayUntil=now+500;
  }
  if(state.lastObstacleScore<30){
    state.emotionOverlay='alert';
    state.emotionOverlayUntil=now+700;
  }
  if(state.emotionOverlay && now>state.emotionOverlayUntil){
    state.emotionOverlay=null;
  }

  state.emotionState = state.emotionOverlay || state.emotionBase;

  state.emotionIntensity =
    state.emotionState==='excited' ? Math.min(1,state.robotVLin)
    : state.emotionState==='happy' ? 0.7
    : state.emotionState==='confident' ? 0.5
    : 0.6;

  document.getElementById("emotion-display").textContent=getEmotionLabel();
}

function getEmotionLabel(){
  return {
    happy:'üê© „ÅÜ„Çå„Åó„ÅÑÔºÅ',
    excited:'üê©‚ú® „Åü„ÅÆ„Åó„ÅÑÔºÅ',
    confident:'üê© ‰ΩôË£ï„Äú',
    curious:'üê©Ôºü „Å™„Å´„Å™„Å´Ôºü',
    alert:'üê©ÔºÅ „Å°„Çá„Å£„Å®ÂæÖ„Å£„Å¶'
  }[state.emotionState]||'üê©';
}

/* =====================
   SOUND
===================== */
function playEmotionSound(){
  const ctx = window.audioCtx || new AudioContext();
  window.audioCtx=ctx;
  const map={
    happy:[[660,80],[880,80]],
    excited:[[880,60],[1100,60],[880,60]],
    curious:[[520,70],[660,70]],
    confident:[[440,120]],
    alert:[[1200,50],[800,50]]
  };
  const seq = map[state.emotionState]||map.happy;
  let t=ctx.currentTime;
  seq.forEach(([f,d])=>{
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.frequency.value=f;
    o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.15*state.emotionIntensity,t);
    g.gain.exponentialRampToValueAtTime(0.01,t+d/1000);
    o.start(t); o.stop(t+d/1000);
    t+=d/1000+0.04;
  });
}

/* =====================
   LOOP
===================== */
function loop(){
  cvCtx.drawImage(video,0,0,cvCanvas.width,cvCanvas.height);
  runML();
  updateEmotionalState();
  if(performance.now()%1200<40) playEmotionSound();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =====================
   INPUT
===================== */
window.addEventListener("keydown",e=>{
  if(e.code==='KeyM'){ state.mlEnabled=!state.mlEnabled; if(state.mlEnabled) loadML(); }
  if(e.code==='KeyR'){
    state.robotEnabled=!state.robotEnabled;
    document.getElementById("robot-mode").textContent=state.robotEnabled?'Á®ºÂÉç':'ÂÅúÊ≠¢';
    document.getElementById("robot-mode").style.color=state.robotEnabled?'#0f0':'#f00';
  }
});
</script>

</body>
</html>
