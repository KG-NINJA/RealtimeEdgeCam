<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>A-1 Robot Vision - Clean Console Version</title>
<style>
/* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã¨åŒã˜ */
* { box-sizing: border-box; }
body { margin: 0; padding: 0; background: #000; color: #0f0; font-family: monospace; font-size: 12px; overflow: hidden; width: 100vw; height: 100vh; }
#camera-feed { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
#cv { display: block; width: 100%; height: 100%; }
#ui { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.9); padding: 12px; border: 2px solid #0f0; z-index: 100; }
.status-line { margin: 5px 0; border-bottom: 1px solid #033; padding-bottom: 2px; }
.robot-sim { position: fixed; bottom: 10px; right: 10px; border: 2px solid #0f0; background: rgba(0,15,0,0.9); z-index: 50; }
#video { position: fixed; left: -10000px; opacity: 0; }
</style>
</head>
<body>

<div id="camera-feed"><canvas id="cv"></canvas></div>
<div id="ui">
  <b>âš™ï¸ A-1 Robot Vision System</b>
  <div class="status-line">ğŸ“Š Obstacle: <span id="obs-score">0.00</span></div>
  <div class="status-line">ğŸ’­ Gemma: <span id="gemma-status">STANDBY</span></div>
  <div class="status-line">ğŸš— Robot: <span id="robot-mode" style="color:#f00">OFF (Rã‚­ãƒ¼)</span></div>
  <div class="status-line">ğŸ“ Decision: <span id="last-decision" style="font-weight:bold;">-</span></div>
</div>
<canvas id="robot-sim" class="robot-sim" width="240" height="240"></canvas>
<video id="video" autoplay playsinline muted></video>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
const state = {
  cvReady: false, mlReady: false, mlEnabled: false, mlInFlight: false,
  lastObstacleScore: 0, robotEnabled: false,
  robotX: 120, robotY: 120, robotTheta: 0, robotVLin: 0, robotVAng: 0,
  gemmaLastAction: 'WAITING', gemmaNextAt: 0
};

const video = document.getElementById('video');
const cvCanvas = document.getElementById('cv');

/* --- 1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç®¡ç† (Warningå¯¾ç­–) --- */
async function loadML() {
  if (window.tf && window.cocoSsd) return; // æ—¢ã«å­˜åœ¨ã™ã‚Œã°ä½•ã‚‚ã—ãªã„
  
  const uiStatus = document.getElementById('ml-status');
  console.log("Loading TensorFlow.js...");
  
  try {
    if (!window.tf) {
      await loadScript("https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0");
    }
    if (!window.cocoSsd) {
      await loadScript("https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3");
    }
    state.model = await cocoSsd.load();
    state.mlReady = true;
    console.log("ML Model Ready");
  } catch (e) {
    console.error("ML Load Error:", e);
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

/* --- 2. ã‚»ãƒ³ã‚µãƒ¼è§£æ & æç”» --- */
const capCanvas = document.createElement('canvas');
const capCtx = capCanvas.getContext('2d', { willReadFrequently: true });

function runCV() {
  if (!state.cvReady) return;
  capCanvas.width = video.videoWidth; capCanvas.height = video.videoHeight;
  capCtx.drawImage(video, 0, 0);
  let src = cv.matFromImageData(capCtx.getImageData(0, 0, video.videoWidth, video.videoHeight));
  let gray = new cv.Mat();
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.Canny(gray, gray, 50, 100);
  cv.imshow(cvCanvas, gray);
  src.delete(); gray.delete();
}

async function runML() {
  if (!state.mlEnabled || !state.mlReady || state.mlInFlight) return;
  state.mlInFlight = true;
  const preds = await state.model.detect(capCanvas);
  // æœ€ã‚‚ã‚¹ã‚³ã‚¢ã®é«˜ã„ç‰©ä½“ã‚’æŠ½å‡º
  let obj = preds.sort((a,b) => b.score - a.score)[0];
  state.lastObstacleScore = obj ? Math.round(obj.score * 1000) : 0;
  document.getElementById('obs-score').textContent = (state.lastObstacleScore/1000).toFixed(3);
  state.mlInFlight = false;
}

/* --- 3. Gemma AI åˆ¤æ–­ (turn_leftå¯¾ç­–) --- */
async function askGemma(now) {
  if (!state.robotEnabled || now < state.gemmaNextAt) return;
  state.gemmaNextAt = now + 2000;

  // è·é›¢è¨ˆç®—ã®è£œæ­£: éšœå®³ç‰©ã‚¹ã‚³ã‚¢ãŒä½ã„ = è·é›¢ãŒé ã„(100)
  const dist = Math.max(5, 100 - Math.round(state.lastObstacleScore / 10));
  
  try {
    const res = await fetch('https://kgninja-functiongemmabotdemo-docker.hf.space/decide', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ front_distance: dist, speed: state.robotVLin })
    });
    const json = await res.json();
    const match = json.data[0].match(/\{.*\}/s);
    if (match) {
      const d = JSON.parse(match[0]);
      state.gemmaLastAction = (d.action || 'STOP').toUpperCase();
      document.getElementById('last-decision').textContent = state.gemmaLastAction;
      
      // æŒ™å‹•ãƒ­ã‚¸ãƒƒã‚¯
      if (state.gemmaLastAction.includes('FORWARD')) { 
        state.robotVLin = 0.6; state.robotVAng = 0; 
      } else { 
        // æ—‹å›æ™‚ã¯å‰é€²é€Ÿåº¦ã‚’è½ã¨ã™
        state.robotVLin = 0.1; 
        state.robotVAng = state.gemmaLastAction.includes('LEFT') ? 1.2 : -1.2; 
      }
    }
  } catch (e) { console.error("API Error"); }
}

/* --- 4. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— & åˆæœŸåŒ– --- */
function animate(now) {
  if (!state.cvReady && video.videoWidth > 0) {
    cvCanvas.width = 320; cvCanvas.height = 240;
    state.cvReady = true;
  }
  runCV();
  runML();
  askGemma(now);
  
  // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æ›´æ–°
  const ctx = document.getElementById('robot-sim').getContext('2d');
  ctx.fillStyle = '#001'; ctx.fillRect(0,0,240,240);
  ctx.fillStyle = '#0f0'; ctx.fillText('AI: '+state.gemmaLastAction, 10, 20);
  if (state.robotEnabled) {
    state.robotTheta += state.robotVAng * 0.1;
    state.robotX += Math.cos(state.robotTheta) * state.robotVLin * 5;
    state.robotY += Math.sin(state.robotTheta) * state.robotVLin * 5;
  }
  ctx.strokeStyle = '#0f0'; ctx.strokeRect(state.robotX-5, state.robotY-5, 10, 10);
  
  requestAnimationFrame(animate);
}

window.addEventListener('keydown', e => {
  if (e.code === 'KeyM') { state.mlEnabled = !state.mlEnabled; loadML(); }
  if (e.code === 'KeyR') { 
    state.robotEnabled = !state.robotEnabled; 
    document.getElementById('robot-mode').textContent = state.robotEnabled ? 'ON' : 'OFF';
    document.getElementById('robot-mode').style.color = state.robotEnabled ? '#0f0' : '#f00';
  }
});

cv['onRuntimeInitialized'] = () => {
  navigator.mediaDevices.getUserMedia({video: true}).then(s => {
    video.srcObject = s;
    video.play();
    requestAnimationFrame(animate);
  });
};
</script>
</body>
</html>
