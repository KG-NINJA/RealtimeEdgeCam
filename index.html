<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>A-1 Poodle Robot â€“ Stable Edition</title>
<style>
body { margin:0; background:#000; color:#0f0; font-family:monospace; overflow:hidden; }
#ui {
  position:fixed; top:10px; left:10px;
  background:rgba(0,0,0,0.85);
  border:2px solid #0f0;
  padding:10px;
  z-index:100;
  min-width:240px;
}
.line { display:flex; justify-content:space-between; margin:4px 0; }
canvas { position:absolute; inset:0; width:100vw; height:100vh; }
video { position:fixed; left:-9999px; }
</style>
</head>

<body>

<canvas id="view"></canvas>

<div id="ui">
  <b>ğŸ© A-1 POODLE ROBOT</b>
  <div class="line"><span>Edgeè·é›¢</span><span id="dist">-</span></div>
  <div class="line"><span>v</span><span id="vlin">0.00</span></div>
  <div class="line"><span>Ï‰</span><span id="vang">0.00</span></div>
  <div class="line"><span>æ„Ÿæƒ…</span><span id="emotion">ğŸ© ã†ã‚Œã—ã„ï¼</span></div>
</div>

<video id="video" autoplay playsinline muted></video>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
/* =====================
   STATE
===================== */
const state = {
  obstacle:100,
  v:0, w:0,
  tv:0.4, tw:0,
  emotion:'happy'
};

const video = document.getElementById('video');
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d');

/* =====================
   CAMERA
===================== */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s => video.srcObject = s);

/* =====================
   OPENCV READY
===================== */
cv['onRuntimeInitialized'] = () => {
  video.addEventListener('loadedmetadata', init);
};

let src, gray, edge;

function init(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  src  = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
  gray = new cv.Mat();
  edge = new cv.Mat();

  requestAnimationFrame(loop);
}

/* =====================
   EDGE + STEERING
===================== */
function loop(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  src.data.set(img.data);

  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
  cv.Canny(gray, edge, 80, 150);

  // å‰æ–¹ä¸­å¤®ã‚¨ãƒƒã‚¸å¯†åº¦
  let count = 0;
  const cx = Math.floor(edge.cols/2);
  const w = Math.floor(edge.cols*0.15);
  for(let y=edge.rows*0.4;y<edge.rows*0.6;y++){
    for(let x=cx-w;x<cx+w;x++){
      if(edge.ucharPtr(y,x)[0]) count++;
    }
  }

  state.obstacle = Math.max(0,100 - count/100);
  document.getElementById('dist').textContent = state.obstacle.toFixed(0);

  /* ---- STEERING ---- */
  if(state.obstacle < 30){
    state.tv = 0.1; state.tw = 0.6;
    state.emotion = 'alert';
  } else if(state.obstacle < 60){
    state.tv = 0.3; state.tw = 0.3;
    state.emotion = 'curious';
  } else {
    state.tv = 0.5; state.tw = 0;
    state.emotion = 'happy';
  }

  state.v += (state.tv - state.v)*0.05;
  state.w += (state.tw - state.w)*0.05;

  document.getElementById('vlin').textContent = state.v.toFixed(2);
  document.getElementById('vang').textContent = state.w.toFixed(2);

  document.getElementById('emotion').textContent = {
    happy:'ğŸ© ã†ã‚Œã—ã„ï¼',
    curious:'ğŸ©ï¼Ÿ ãªã«ãªã«ï¼Ÿ',
    alert:'ğŸ©ï¼ ã¡ã‚‡ã£ã¨å¾…ã£ã¦'
  }[state.emotion];

  /* ---- DRAW EDGE OVERLAY ---- */
  const edgeImg = new ImageData(
    new Uint8ClampedArray(edge.data),
    edge.cols,
    edge.rows
  );
  ctx.globalAlpha = 0.4;
  ctx.putImageData(edgeImg,0,0);
  ctx.globalAlpha = 1;

  requestAnimationFrame(loop);
}
</script>

</body>
</html>
